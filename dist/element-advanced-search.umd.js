(function(e,_){typeof exports=="object"&&typeof module<"u"?module.exports=_(require("vue"),require("element-plus")):typeof define=="function"&&define.amd?define(["vue","element-plus"],_):(e=typeof globalThis<"u"?globalThis:e||self,e.ElementAdvancedSearch=_(e.Vue,e.ElementPlus))})(this,function(e,_){"use strict";const j={class:"advanced-search"},K={class:"main-search-bar"},L={class:"filter-button-wrapper"},J={class:"advanced-search-form-popover"},M=["data-field"],W={key:9,class:"numberrange-container"},z={key:0,class:"search-tags"},H=e.defineComponent({__name:"index",props:{searchConfig:{},quickSearchField:{default:"keyword"},modelValue:{default:()=>({})},cacheKey:{default:""}},emits:["search","update:modelValue"],setup(v,{emit:A}){let m=null;const d=v,p=A,Q=e.ref(null),k=e.ref(!1),i=e.ref(""),c=e.ref({}),h=e.ref([]),b=e.ref({}),y=e.ref({}),x=e.ref({}),F=(l,o)=>{const a=c.value[l];return Array.isArray(a)&&a.length>o?a[o]:null},T=(l,o,a)=>{Array.isArray(c.value[l])||(c.value[l]=[null,null]),c.value[l][o]=a};e.watch(()=>y.value,()=>{h.value.length>0&&h.value.some(o=>{const a=d.searchConfig.formItems.find(r=>r.field===o.key);return a&&(a.type==="select"||a.type==="treeselect")&&(a.remote||a.loadOptions)})&&(m&&clearTimeout(m),m=window.setTimeout(()=>{e.nextTick(()=>{E()})},100))},{deep:!0});const I=e.computed(()=>d.searchConfig.formItems.length>1),G=e.computed(()=>d.searchConfig.formItems.filter(l=>!l.hidden)),X=e.computed(()=>d.searchConfig.popoverWidth||800),g=e.computed(()=>d.cacheKey?`advancedSearch@${d.cacheKey}`:""),Y=l=>{b.value[l]=!0,e.nextTick(()=>{const o=document.querySelector(`[data-field=${l}] .form-item-textarea-overlay textarea`);o&&o.focus()})},U=l=>{if(l.type==="select"||l.type==="treeselect"){const o=l;return o.remote&&y.value[l.field]?y.value[l.field]:o.options||[]}return[]},Z=l=>U(l),ee=l=>{if(l.type!=="select"&&l.type!=="treeselect")return;const o=l;return async a=>{if(o.remoteMethod){x.value[l.field]=!0;try{const r=await o.remoteMethod(a);y.value[l.field]=r}catch(r){console.error(`Failed to load remote options for ${l.field}:`,r)}finally{x.value[l.field]=!1}}}},D=l=>{if(g.value)try{localStorage.setItem(g.value,JSON.stringify({searchParams:l,timestamp:Date.now()}))}catch(o){console.warn("Failed to save search cache:",o)}},le=()=>{if(!g.value)return null;try{const l=localStorage.getItem(g.value);if(l){const o=JSON.parse(l),a=Date.now(),r=24*60*60*1e3;return a-o.timestamp>r?(B(),null):o.searchParams||null}}catch(l){console.warn("Failed to get search cache:",l),B()}return null},B=()=>{if(g.value)try{localStorage.removeItem(g.value)}catch(l){console.warn("Failed to clear search cache:",l)}},E=()=>{const l={};i.value&&(l[d.quickSearchField]=i.value),Object.assign(l,c.value);const o=h.value,a=[];i.value&&a.push({key:d.quickSearchField,label:"关键词",value:i.value});for(const r of d.searchConfig.formItems){const n=l[r.field];n!=null&&n!==""&&!(Array.isArray(n)&&n.length===0)&&(r.type==="numberrange"?Array.isArray(n)&&(n[0]!==null||n[1]!==null)&&a.push({key:r.field,label:r.label,value:n}):r.type==="daterange"?Array.isArray(n)&&n.length===2&&(n[0]!==null||n[1]!==null)&&a.push({key:r.field,label:r.label,value:n}):a.push({key:r.field,label:r.label,value:n}))}ae(o,a)||(h.value=a)},ae=(l,o)=>{if(l.length!==o.length)return!1;for(let a=0;a<l.length;a++)if(l[a].key!==o[a].key||l[a].label!==o[a].label||JSON.stringify(l[a].value)!==JSON.stringify(o[a].value))return!1;return!0},oe=()=>{},te=()=>{k.value=!1},$=()=>{const l={};i.value&&(l[d.quickSearchField]=i.value),Object.assign(l,c.value),V(l),D(l),p("update:modelValue",l),p("search",l)},P=()=>{const l={};i.value&&(l[d.quickSearchField]=i.value),Object.assign(l,c.value),V(l),D(l),te(),p("update:modelValue",l),p("search",l)},q=()=>{const l={};for(const a of d.searchConfig.formItems)if(a.type==="custom")c.value[a.field]=a.default!==void 0?a.default:"";else if(a.type==="checkbox")c.value[a.field]=[];else if(a.type==="daterange"||a.type==="numberrange")c.value[a.field]=[];else if(a.type==="treeselect"){const r=a;c.value[a.field]=r.multiple?[]:""}else if(a.type==="select"){const r=a;c.value[a.field]=r.multiple?[]:""}else a.type==="textarea"?(c.value[a.field]=a.default??"",l[a.field]=!1):c.value[a.field]=a.default??"";b.value=l,h.value=[],B();const o={};i.value&&(o[d.quickSearchField]=i.value),p("update:modelValue",o),p("search",o)},V=l=>{const o=[];i.value&&o.push({key:d.quickSearchField,label:"关键词",value:i.value});for(const a of d.searchConfig.formItems){const r=l[a.field];r!=null&&r!==""&&!(Array.isArray(r)&&r.length===0)&&(a.type==="numberrange"?Array.isArray(r)&&(r[0]!==null||r[1]!==null)&&o.push({key:a.field,label:a.label,value:r}):a.type==="daterange"?Array.isArray(r)&&r.length===2&&(r[0]!==null||r[1]!==null)&&o.push({key:a.field,label:a.label,value:r}):o.push({key:a.field,label:a.label,value:r}))}h.value=o},re=l=>{const o=d.searchConfig.formItems.find(a=>a.field===l.key);if(o&&o.type==="custom")return o.displayValue?o.displayValue(l.value,c.value):String(l.value);if(o&&(o.type==="select"||o.type==="treeselect")&&(o.options||y.value[o.field])){const a=o,r=a.remote?y.value[o.field]:a.options,n=o.type==="treeselect"&&o.nodeKey||"value";if(Array.isArray(l.value))return l.value.map(f=>{const u=w(r||[],f,n);return u?u.label:f}).join(", ");{const f=w(r||[],l.value,n);return f?f.label:l.value}}if(o&&(o.type==="radio"||o.type==="checkbox")&&o.options){if(Array.isArray(l.value))return l.value.map(a=>{var n;const r=(n=o.options)==null?void 0:n.find(f=>f.value===a);return r?r.label:a}).join(", ");{const a=o.options.find(r=>r.value===l.value);return a?a.label:l.value}}if(o&&o.type==="daterange"&&Array.isArray(l.value)){if(l.value.length===2){const[a,r]=l.value;if(a!==null&&r!==null)return`${C(a)} ~ ${C(r)}`;if(a!==null)return`≥ ${C(a)}`;if(r!==null)return`≤ ${C(r)}`}return""}if(o&&o.type==="numberrange"&&Array.isArray(l.value)){const[a,r]=l.value;return a!==null&&r!==null?`${a} - ${r}`:a!==null?`≥ ${a}`:r!==null?`≤ ${r}`:""}return l.value},C=l=>{if(l instanceof Date)return l.toLocaleDateString();if(typeof l=="string"||typeof l=="number"){const o=new Date(l);return isNaN(o.getTime())?String(l):o.toLocaleDateString()}return String(l)},w=(l,o,a)=>{for(const r of l){if(r[a]===o)return r;if(r.children&&r.children.length>0){const n=w(r.children,o,a);if(n)return n}}return null},ne=l=>{if(l===d.quickSearchField)i.value="";else{const o=d.searchConfig.formItems.find(a=>a.field===l);if(o)if(o.type==="checkbox")c.value[l]=[];else if(o.type==="daterange"||o.type==="numberrange")c.value[l]=[];else if(o.type==="select"||o.type==="treeselect"){const a=o;c.value[l]=a.multiple?[]:""}else c.value[l]="";else c.value[l]=""}P()},ce=()=>{i.value="",q()},se=async()=>{for(const l of d.searchConfig.formItems)if((l.type==="select"||l.type==="treeselect")&&l.loadOptions){const o=l;try{const a=await o.loadOptions();y.value[l.field]=a,h.value.length>0&&(m&&clearTimeout(m),m=window.setTimeout(()=>{e.nextTick(()=>{E()})},100))}catch(a){console.error(`Failed to load options for ${l.field}:`,a)}}};return e.watch(()=>d.modelValue,l=>{l&&(i.value=l[d.quickSearchField]||"",Object.keys(l).forEach(o=>{if(o!==d.quickSearchField){const a=d.searchConfig.formItems.find(r=>r.field===o);a&&a.type==="checkbox"&&!Array.isArray(l[o])?c.value[o]=l[o]?[l[o]]:[]:a&&a.type==="daterange"&&l[o]?Array.isArray(l[o])?c.value[o]=l[o].map(r=>{if(r instanceof Date)return r;if(typeof r=="string"||typeof r=="number"){const n=new Date(r);return isNaN(n.getTime())?r:n}return r}):c.value[o]=[]:a&&a.type==="numberrange"&&l[o]?Array.isArray(l[o])?c.value[o]=l[o]:c.value[o]=[null,null]:c.value[o]=l[o]}}),V(l))},{immediate:!0}),e.onMounted(()=>{const l={},o={};for(const n of d.searchConfig.formItems)if(n.type==="custom")l[n.field]=n.default!==void 0?n.default:"";else if(n.type==="checkbox")l[n.field]=Array.isArray(n.default)?n.default:[];else if(n.type==="treeselect"){const f=n;l[n.field]=f.multiple?Array.isArray(n.default)?n.default:[]:n.default??""}else if(n.type==="select"){const f=n;l[n.field]=f.multiple?Array.isArray(n.default)?n.default:[]:n.default??""}else n.type==="daterange"?l[n.field]=Array.isArray(n.default)?n.default:[]:n.type==="numberrange"?l[n.field]=Array.isArray(n.default)?n.default:[null,null]:n.type==="textarea"?(l[n.field]=n.default??"",o[n.field]=!1):l[n.field]=n.default??"";c.value=l,b.value=o;const a=le();a&&(i.value=a[d.quickSearchField]||"",Object.keys(a).forEach(n=>{if(n!==d.quickSearchField){const f=d.searchConfig.formItems.find(u=>u.field===n);f&&f.type==="checkbox"&&!Array.isArray(a[n])?l[n]=a[n]?[a[n]]:[]:f&&f.type==="daterange"&&a[n]?Array.isArray(a[n])?l[n]=a[n].map(u=>{if(u instanceof Date)return u;if(typeof u=="string"||typeof u=="number"){const S=new Date(u);return isNaN(S.getTime())?u:S}return u}):l[n]=[]:f&&f.type==="numberrange"&&a[n]?Array.isArray(a[n])?l[n]=a[n]:l[n]=[null,null]:l[n]=a[n]}})),c.value=l;const r={};i.value&&(r[d.quickSearchField]=i.value),Object.assign(r,c.value),V(r),a&&(p("update:modelValue",r),p("search",r)),se()}),(l,o)=>{const a=e.resolveComponent("el-input"),r=e.resolveComponent("el-button"),n=e.resolveComponent("el-option"),f=e.resolveComponent("el-select"),u=e.resolveComponent("el-tree-select"),S=e.resolveComponent("el-radio"),de=e.resolveComponent("el-radio-group"),ie=e.resolveComponent("el-checkbox"),fe=e.resolveComponent("el-checkbox-group"),O=e.resolveComponent("el-date-picker"),N=e.resolveComponent("el-input-number"),R=e.resolveComponent("el-form-item"),ue=e.resolveComponent("el-col"),pe=e.resolveComponent("el-row"),me=e.resolveComponent("el-popover"),he=e.resolveComponent("el-tag");return e.openBlock(),e.createElementBlock("div",j,[e.createElementVNode("div",K,[e.createVNode(a,{modelValue:i.value,"onUpdate:modelValue":o[0]||(o[0]=t=>i.value=t),placeholder:"请输入搜索关键词",class:"quick-search-input",onKeyup:e.withKeys($,["enter"])},null,8,["modelValue"]),e.createVNode(r,{type:"primary",icon:"Search",onClick:$,class:"search-button"},{default:e.withCtx(()=>o[2]||(o[2]=[e.createTextVNode(" 搜索 ",-1)])),_:1,__:[2]}),e.createElementVNode("div",L,[I.value?(e.openBlock(),e.createBlock(me,{key:0,visible:k.value,"onUpdate:visible":o[1]||(o[1]=t=>k.value=t),placement:"bottom-end",width:X.value,trigger:"click","popper-class":"advanced-search-popover",teleported:!0},{reference:e.withCtx(()=>[I.value?(e.openBlock(),e.createBlock(r,{key:0,ref:"filterButtonRef",onClick:oe,icon:k.value?"ArrowUp":"ArrowDown",class:"filter-button"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(k.value?"收起筛选":"更多筛选"),1)]),_:1},8,["icon"])):e.createCommentVNode("",!0)]),default:e.withCtx(()=>[e.createElementVNode("div",J,[e.createVNode(e.unref(_.ElForm),{ref_key:"advancedFormRef",ref:Q,model:c.value,"label-width":l.searchConfig.labelWidth||"100px",inline:l.searchConfig.inline!==!1,class:"advanced-form"},{default:e.withCtx(()=>[e.createVNode(pe,{gutter:20},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(G.value,t=>(e.openBlock(),e.createBlock(ue,{key:t.field,span:24/(l.searchConfig.itemsPerRow||2),class:"advanced-form-item-col"},{default:e.withCtx(()=>[e.createVNode(R,{label:t.label,prop:t.field,class:"advanced-form-item"},{default:e.withCtx(()=>[t.type==="input"||!t.type?(e.openBlock(),e.createBlock(a,{key:0,modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,placeholder:t.placeholder||`请输入${t.label}`,clearable:t.clearable!==!1,class:"form-item-input"},null,8,["modelValue","onUpdate:modelValue","placeholder","clearable"])):t.type==="textarea"?(e.openBlock(),e.createElementBlock("div",{key:1,class:"textarea-container","data-field":t.field},[e.withDirectives(e.createVNode(a,{modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,placeholder:t.shortPlaceholder||t.placeholder||`请输入${t.label}`,clearable:t.clearable!==!1,class:"form-item-input",onFocus:s=>Y(t.field)},null,8,["modelValue","onUpdate:modelValue","placeholder","clearable","onFocus"]),[[e.vShow,!b.value[t.field]]]),e.withDirectives(e.createVNode(a,{modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,placeholder:t.longPlaceholder||t.placeholder||`请输入${t.label}`,clearable:t.clearable!==!1,type:"textarea",autosize:{minRows:2,maxRows:4},class:"form-item-textarea-overlay",teleported:!0,onBlur:()=>{b.value[t.field]=!1}},null,8,["modelValue","onUpdate:modelValue","placeholder","clearable","onBlur"]),[[e.vShow,b.value[t.field]]])],8,M)):t.type==="select"?(e.openBlock(),e.createBlock(f,{key:2,modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,placeholder:t.placeholder||`请选择${t.label}`,clearable:t.clearable!==!1,multiple:t.multiple,filterable:t.filterable,remote:t.remote,"remote-method":t.remote?ee(t):void 0,loading:x.value[t.field]||!1,class:"form-item-select",teleported:!1,"reserve-keyword":""},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(U(t),s=>(e.openBlock(),e.createBlock(n,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","clearable","multiple","filterable","remote","remote-method","loading"])):t.type==="treeselect"?(e.openBlock(),e.createBlock(u,{key:3,modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,placeholder:t.placeholder||`请选择${t.label}`,clearable:t.clearable!==!1,multiple:t.multiple,data:Z(t),"node-key":t.nodeKey||"value",props:t.props||{value:"value",label:"label",children:"children"},"show-checkbox":t.showCheckbox,filterable:t.filterable,teleported:!1,"popper-options":{placement:"bottom-start"},style:e.normalizeStyle({"--el-tree-select-dropdown-max-height":(t.maxDropdownHeight||300)+"px"}),"render-after-expand":!1,loading:x.value[t.field]||!1},null,8,["modelValue","onUpdate:modelValue","placeholder","clearable","multiple","data","node-key","props","show-checkbox","filterable","style","loading"])):t.type==="radio"?(e.openBlock(),e.createBlock(de,{key:4,modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,class:"form-item-radio"},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.options,s=>(e.openBlock(),e.createBlock(S,{key:s.value,value:s.value,class:"form-item-radio-option"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(s.label),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.type==="checkbox"?(e.openBlock(),e.createBlock(fe,{key:5,modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,class:"form-item-checkbox"},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.options,s=>(e.openBlock(),e.createBlock(ie,{key:s.value,value:s.value,class:"form-item-checkbox-option"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(s.label),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.type==="date"?(e.openBlock(),e.createBlock(O,{key:6,modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,type:"date",placeholder:t.placeholder||`请选择${t.label}`,clearable:t.clearable!==!1,class:"form-item-date",teleported:!1},null,8,["modelValue","onUpdate:modelValue","placeholder","clearable"])):t.type==="daterange"?(e.openBlock(),e.createBlock(O,{key:7,modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,type:"daterange","start-placeholder":t.startPlaceholder||"开始日期","end-placeholder":t.endPlaceholder||"结束日期",clearable:t.clearable!==!1,class:"form-item-daterange",teleported:!1,"range-separator":"至"},null,8,["modelValue","onUpdate:modelValue","start-placeholder","end-placeholder","clearable"])):t.type==="number"?(e.openBlock(),e.createBlock(N,{key:8,modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,min:t.min,max:t.max,placeholder:t.placeholder||`请输入${t.label}`,"controls-position":t.controlsPosition||"right",class:"form-item-number"},null,8,["modelValue","onUpdate:modelValue","min","max","placeholder","controls-position"])):t.type==="numberrange"?(e.openBlock(),e.createElementBlock("div",W,[e.createVNode(N,{"model-value":F(t.field,0),min:t.min,max:t.max,placeholder:t.minPlaceholder||"最小值","controls-position":t.controlsPosition||"right",class:"form-item-number","onUpdate:modelValue":s=>T(t.field,0,s??null)},null,8,["model-value","min","max","placeholder","controls-position","onUpdate:modelValue"]),o[3]||(o[3]=e.createElementVNode("span",{class:"range-separator"},"-",-1)),e.createVNode(N,{"model-value":F(t.field,1),min:t.min,max:t.max,placeholder:t.maxPlaceholder||"最大值","controls-position":t.controlsPosition||"right",class:"form-item-number","onUpdate:modelValue":s=>T(t.field,1,s??null)},null,8,["model-value","min","max","placeholder","controls-position","onUpdate:modelValue"])])):t.type==="custom"?e.renderSlot(l.$slots,t.slotName||t.field,{key:10,model:c.value,field:t.field},void 0,!0):e.createCommentVNode("",!0)]),_:2},1032,["label","prop"])]),_:2},1032,["span"]))),128))]),_:3}),e.createVNode(R,{class:"advanced-form-actions","label-width":l.searchConfig.labelWidth||"100px",label:" "},{default:e.withCtx(()=>[e.createVNode(r,{type:"primary",icon:"Search",onClick:P},{default:e.withCtx(()=>o[4]||(o[4]=[e.createTextVNode(" 搜索 ",-1)])),_:1,__:[4]}),e.createVNode(r,{onClick:q,icon:"Refresh"},{default:e.withCtx(()=>o[5]||(o[5]=[e.createTextVNode(" 重置 ",-1)])),_:1,__:[5]})]),_:1},8,["label-width"])]),_:3},8,["model","label-width","inline"])])]),_:3},8,["visible","width"])):e.createCommentVNode("",!0)])]),h.value.length>0?(e.openBlock(),e.createElementBlock("div",z,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(h.value,t=>(e.openBlock(),e.createBlock(he,{key:t.key,closable:"",onClose:s=>ne(t.key),class:"search-tag"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(t.label)+": "+e.toDisplayString(re(t)),1)]),_:2},1032,["onClose"]))),128)),e.createVNode(r,{type:"primary",link:"",onClick:ce,class:"clear-all-tags"},{default:e.withCtx(()=>o[6]||(o[6]=[e.createTextVNode(" 清除所有 ",-1)])),_:1,__:[6]})])):e.createCommentVNode("",!0)])}}}),ye="",be="";return((v,A)=>{const m=v.__vccOpts||v;for(const[d,p]of A)m[d]=p;return m})(H,[["__scopeId","data-v-ca879d08"]])});

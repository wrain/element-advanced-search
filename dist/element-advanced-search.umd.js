(function(m,e){typeof exports=="object"&&typeof module<"u"?e(exports,require("vue"),require("element-plus")):typeof define=="function"&&define.amd?define(["exports","vue","element-plus"],e):(m=typeof globalThis<"u"?globalThis:m||self,e(m.ElementAdvancedSearch={},m.Vue,m.ElementPlus))})(this,function(m,e,K){"use strict";const L={class:"advanced-search"},M={class:"main-search-bar"},J={class:"filter-button-wrapper"},W={class:"advanced-search-form-popover"},z=["data-field"],H={key:9,class:"numberrange-container"},Q={key:0,class:"search-tags"},G=e.defineComponent({__name:"index",props:{searchConfig:{},quickSearchField:{default:"keyword"},quickSearchPlaceholder:{default:"请输入搜索关键词"},modelValue:{default:()=>({})},cacheKey:{default:""}},emits:["search","update:modelValue"],setup(x,{emit:A}){let h=null;const d=x,p=A,X=e.ref(null),v=e.ref(!1),f=e.ref(""),c=e.ref({}),y=e.ref([]),g=e.ref({}),b=e.ref({}),V=e.ref({}),T=(l,o)=>{const a=c.value[l];return Array.isArray(a)&&a.length>o?a[o]:null},I=(l,o,a)=>{Array.isArray(c.value[l])||(c.value[l]=[null,null]),c.value[l][o]=a};e.watch(()=>b.value,()=>{y.value.length>0&&y.value.some(o=>{const a=d.searchConfig.formItems.find(n=>n.field===o.key);return a&&(a.type==="select"||a.type==="treeselect")&&(a.remote||a.loadOptions)})&&(h&&clearTimeout(h),h=window.setTimeout(()=>{e.nextTick(()=>{q()})},100))},{deep:!0});const U=e.computed(()=>d.searchConfig.formItems.length>1),Y=e.computed(()=>d.searchConfig.formItems.filter(l=>!l.hidden)),Z=e.computed(()=>d.searchConfig.popoverWidth||800),_=e.computed(()=>d.cacheKey?`advancedSearch@${d.cacheKey}`:""),ee=l=>{g.value[l]=!0,e.nextTick(()=>{const o=document.querySelector(`[data-field=${l}] .form-item-textarea-overlay textarea`);o&&o.focus()})},D=l=>{if(l.type==="select"||l.type==="treeselect"){const o=l;return o.remote&&b.value[l.field]?b.value[l.field]:o.options||[]}return[]},le=l=>D(l),ae=l=>{if(l.type!=="select"&&l.type!=="treeselect")return;const o=l;return async a=>{if(o.remoteMethod){V.value[l.field]=!0;try{const n=await o.remoteMethod(a);b.value[l.field]=n}catch(n){console.error(`Failed to load remote options for ${l.field}:`,n)}finally{V.value[l.field]=!1}}}},P=l=>{if(_.value)try{localStorage.setItem(_.value,JSON.stringify({searchParams:l,timestamp:Date.now()}))}catch(o){console.warn("Failed to save search cache:",o)}},oe=()=>{if(!_.value)return null;try{const l=localStorage.getItem(_.value);if(l){const o=JSON.parse(l),a=Date.now(),n=24*60*60*1e3;return a-o.timestamp>n?(B(),null):o.searchParams||null}}catch(l){console.warn("Failed to get search cache:",l),B()}return null},B=()=>{if(_.value)try{localStorage.removeItem(_.value)}catch(l){console.warn("Failed to clear search cache:",l)}},q=()=>{const l={};f.value&&(l[d.quickSearchField]=f.value),Object.assign(l,c.value);const o=y.value,a=[];f.value&&a.push({key:d.quickSearchField,label:"关键词",value:f.value});for(const n of d.searchConfig.formItems){const r=l[n.field];r!=null&&r!==""&&!(Array.isArray(r)&&r.length===0)&&(n.type==="numberrange"?Array.isArray(r)&&(r[0]!==null||r[1]!==null)&&a.push({key:n.field,label:n.label,value:r}):n.type==="daterange"?Array.isArray(r)&&r.length===2&&(r[0]!==null||r[1]!==null)&&a.push({key:n.field,label:n.label,value:r}):n.field!==d.quickSearchField&&a.push({key:n.field,label:n.label,value:r}))}te(o,a)||(y.value=a)},te=(l,o)=>{if(l.length!==o.length)return!1;for(let a=0;a<l.length;a++)if(l[a].key!==o[a].key||l[a].label!==o[a].label||JSON.stringify(l[a].value)!==JSON.stringify(o[a].value))return!1;return!0},re=()=>{},ne=()=>{v.value=!1},E=()=>{const l={};f.value&&(l[d.quickSearchField]=f.value),Object.assign(l,c.value),C(l),P(l),p("update:modelValue",l),p("search",l)},$=()=>{const l={};f.value&&(l[d.quickSearchField]=f.value),Object.assign(l,c.value),C(l),P(l),ne(),p("update:modelValue",l),p("search",l)},O=()=>{const l={};for(const a of d.searchConfig.formItems)if(a.type==="custom")c.value[a.field]=a.default!==void 0?a.default:"";else if(a.type==="checkbox")c.value[a.field]=[];else if(a.type==="daterange"||a.type==="numberrange")c.value[a.field]=[];else if(a.type==="treeselect"){const n=a;c.value[a.field]=n.multiple?[]:""}else if(a.type==="select"){const n=a;c.value[a.field]=n.multiple?[]:""}else a.type==="textarea"?(c.value[a.field]=a.default??"",l[a.field]=!1):a.type==="number"?c.value[a.field]=a.default??null:c.value[a.field]=a.default??"";g.value=l,y.value=[],B();const o={};f.value&&(o[d.quickSearchField]=f.value),p("update:modelValue",o),p("search",o)},C=l=>{const o=[];f.value&&o.push({key:d.quickSearchField,label:"关键词",value:f.value});for(const a of d.searchConfig.formItems){const n=l[a.field];n!=null&&n!==""&&!(Array.isArray(n)&&n.length===0)&&(a.type==="numberrange"?Array.isArray(n)&&(n[0]!==null||n[1]!==null)&&o.push({key:a.field,label:a.label,value:n}):a.type==="daterange"?Array.isArray(n)&&n.length===2&&(n[0]!==null||n[1]!==null)&&o.push({key:a.field,label:a.label,value:n}):a.field!==d.quickSearchField&&o.push({key:a.field,label:a.label,value:n}))}y.value=o},ce=l=>{const o=d.searchConfig.formItems.find(a=>a.field===l.key);if(o&&o.displayValue)return o.displayValue(l.value,c.value);if(o&&(o.type==="select"||o.type==="treeselect")&&(o.options||b.value[o.field])){const a=o,n=a.remote?b.value[o.field]:a.options,r=o.type==="treeselect"&&o.nodeKey||"value";if(Array.isArray(l.value))return l.value.map(i=>{const u=w(n||[],i,r);return u?u.label:i}).join(", ");{const i=w(n||[],l.value,r);return i?i.label:l.value}}if(o&&(o.type==="radio"||o.type==="checkbox")&&o.options){if(Array.isArray(l.value))return l.value.map(a=>{var r;const n=(r=o.options)==null?void 0:r.find(i=>i.value===a);return n?n.label:a}).join(", ");{const a=o.options.find(n=>n.value===l.value);return a?a.label:l.value}}if(o&&o.type==="daterange"&&Array.isArray(l.value)){if(l.value.length===2){const[a,n]=l.value;if(a!==null&&n!==null)return`${k(a)} ~ ${k(n)}`;if(a!==null)return`≥ ${k(a)}`;if(n!==null)return`≤ ${k(n)}`}return""}if(o&&o.type==="date")return l.value?k(l.value):"";if(o&&o.type==="numberrange"&&Array.isArray(l.value)){const[a,n]=l.value;return a!==null&&n!==null?`${a} - ${n}`:a!==null?`≥ ${a}`:n!==null?`≤ ${n}`:""}return l.value},k=l=>{if(l instanceof Date)return l.toLocaleDateString();if(typeof l=="string"||typeof l=="number"){const o=new Date(l);return isNaN(o.getTime())?String(l):o.toLocaleDateString()}return String(l)},w=(l,o,a)=>{for(const n of l){if(n[a]===o)return n;if(n.children&&n.children.length>0){const r=w(n.children,o,a);if(r)return r}}return null},se=l=>{if(l===d.quickSearchField)f.value="";else{const o=d.searchConfig.formItems.find(a=>a.field===l);if(o)if(o.type==="checkbox")c.value[l]=[];else if(o.type==="daterange"||o.type==="numberrange")c.value[l]=[];else if(o.type==="select"||o.type==="treeselect"){const a=o;c.value[l]=a.multiple?[]:""}else o.type==="number"?c.value[l]=null:c.value[l]="";else c.value[l]=""}$()},de=()=>{f.value="",O()},ie=async()=>{for(const l of d.searchConfig.formItems)if((l.type==="select"||l.type==="treeselect")&&l.loadOptions){const o=l;try{const a=await o.loadOptions();b.value[l.field]=a,y.value.length>0&&(h&&clearTimeout(h),h=window.setTimeout(()=>{e.nextTick(()=>{q()})},100))}catch(a){console.error(`Failed to load options for ${l.field}:`,a)}}};return e.watch(()=>d.modelValue,l=>{l&&(f.value=l[d.quickSearchField]||"",Object.keys(l).forEach(o=>{if(o!==d.quickSearchField){const a=d.searchConfig.formItems.find(n=>n.field===o);a&&a.type==="checkbox"&&!Array.isArray(l[o])?c.value[o]=l[o]?[l[o]]:[]:a&&a.type==="daterange"&&l[o]?Array.isArray(l[o])?c.value[o]=l[o].map(n=>{if(n instanceof Date)return n;if(typeof n=="string"||typeof n=="number"){const r=new Date(n);return isNaN(r.getTime())?n:r}return n}):c.value[o]=[]:a&&a.type==="numberrange"&&l[o]?Array.isArray(l[o])?c.value[o]=l[o]:c.value[o]=[null,null]:a&&a.type==="number"&&(l[o]===""||l[o]===void 0)?c.value[o]=null:c.value[o]=l[o]}}),C(l))},{immediate:!0}),e.onMounted(()=>{const l={},o={};for(const r of d.searchConfig.formItems)if(r.type==="custom")l[r.field]=r.default!==void 0?r.default:"";else if(r.type==="checkbox")l[r.field]=Array.isArray(r.default)?r.default:[];else if(r.type==="treeselect"){const i=r;l[r.field]=i.multiple?Array.isArray(r.default)?r.default:[]:r.default??""}else if(r.type==="select"){const i=r;l[r.field]=i.multiple?Array.isArray(r.default)?r.default:[]:r.default??""}else r.type==="daterange"?l[r.field]=Array.isArray(r.default)?r.default:[]:r.type==="numberrange"?l[r.field]=Array.isArray(r.default)?r.default:[null,null]:r.type==="textarea"?(l[r.field]=r.default??"",o[r.field]=!1):r.type==="number"?l[r.field]=r.default??null:l[r.field]=r.default??"";c.value=l,g.value=o;const a=oe();a&&(f.value=a[d.quickSearchField]||"",Object.keys(a).forEach(r=>{if(r!==d.quickSearchField){const i=d.searchConfig.formItems.find(u=>u.field===r);if(i&&i.type==="checkbox"&&!Array.isArray(a[r]))l[r]=a[r]?[a[r]]:[];else if(i&&i.type==="date"&&a[r])if(typeof a[r]=="string"||typeof a[r]=="number"){const u=new Date(a[r]);l[r]=isNaN(u.getTime())?a[r]:u}else l[r]=a[r];else i&&i.type==="daterange"&&a[r]?Array.isArray(a[r])?l[r]=a[r].map(u=>{if(u instanceof Date)return u;if(typeof u=="string"||typeof u=="number"){const S=new Date(u);return isNaN(S.getTime())?u:S}return u}):l[r]=[]:i&&i.type==="numberrange"&&a[r]?Array.isArray(a[r])?l[r]=a[r]:l[r]=[null,null]:l[r]=a[r]}})),c.value=l;const n={};f.value&&(n[d.quickSearchField]=f.value),Object.assign(n,c.value),C(n),a&&(p("update:modelValue",n),p("search",n)),ie()}),(l,o)=>{const a=e.resolveComponent("el-input"),n=e.resolveComponent("el-button"),r=e.resolveComponent("el-option"),i=e.resolveComponent("el-select"),u=e.resolveComponent("el-tree-select"),S=e.resolveComponent("el-radio"),fe=e.resolveComponent("el-radio-group"),ue=e.resolveComponent("el-checkbox"),pe=e.resolveComponent("el-checkbox-group"),R=e.resolveComponent("el-date-picker"),N=e.resolveComponent("el-input-number"),j=e.resolveComponent("el-form-item"),me=e.resolveComponent("el-col"),he=e.resolveComponent("el-row"),ye=e.resolveComponent("el-popover"),be=e.resolveComponent("el-tag");return e.openBlock(),e.createElementBlock("div",L,[e.createElementVNode("div",M,[e.createVNode(a,{modelValue:f.value,"onUpdate:modelValue":o[0]||(o[0]=t=>f.value=t),placeholder:l.quickSearchPlaceholder,class:"quick-search-input",onKeyup:e.withKeys(E,["enter"])},null,8,["modelValue","placeholder"]),e.createVNode(n,{type:"primary",icon:"Search",onClick:E,class:"search-button"},{default:e.withCtx(()=>o[2]||(o[2]=[e.createTextVNode(" 搜索 ",-1)])),_:1,__:[2]}),e.createElementVNode("div",J,[U.value?(e.openBlock(),e.createBlock(ye,{key:0,visible:v.value,"onUpdate:visible":o[1]||(o[1]=t=>v.value=t),placement:"bottom-end",width:Z.value,trigger:"click","popper-class":"advanced-search-popover",teleported:!0},{reference:e.withCtx(()=>[U.value?(e.openBlock(),e.createBlock(n,{key:0,ref:"filterButtonRef",onClick:re,icon:v.value?"ArrowUp":"ArrowDown",class:"filter-button"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(v.value?"收起筛选":"更多筛选"),1)]),_:1},8,["icon"])):e.createCommentVNode("",!0)]),default:e.withCtx(()=>[e.createElementVNode("div",W,[e.createVNode(e.unref(K.ElForm),{ref_key:"advancedFormRef",ref:X,model:c.value,"label-width":l.searchConfig.labelWidth||"100px",inline:l.searchConfig.inline!==!1,class:"advanced-form"},{default:e.withCtx(()=>[e.createVNode(he,{gutter:20},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(Y.value,t=>(e.openBlock(),e.createBlock(me,{key:t.field,span:24/(l.searchConfig.itemsPerRow||2),class:"advanced-form-item-col"},{default:e.withCtx(()=>[e.createVNode(j,{label:t.label,prop:t.field,class:"advanced-form-item"},{default:e.withCtx(()=>[t.type==="input"||!t.type?(e.openBlock(),e.createBlock(a,{key:0,modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,placeholder:t.placeholder||`请输入${t.label}`,clearable:t.clearable!==!1,class:"form-item-input"},null,8,["modelValue","onUpdate:modelValue","placeholder","clearable"])):t.type==="textarea"?(e.openBlock(),e.createElementBlock("div",{key:1,class:"textarea-container","data-field":t.field},[e.withDirectives(e.createVNode(a,{modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,placeholder:t.shortPlaceholder||t.placeholder||`请输入${t.label}`,clearable:t.clearable!==!1,class:"form-item-input",onFocus:s=>ee(t.field)},null,8,["modelValue","onUpdate:modelValue","placeholder","clearable","onFocus"]),[[e.vShow,!g.value[t.field]]]),e.withDirectives(e.createVNode(a,{modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,placeholder:t.longPlaceholder||t.placeholder||`请输入${t.label}`,clearable:t.clearable!==!1,type:"textarea",autosize:{minRows:2,maxRows:4},class:"form-item-textarea-overlay",teleported:!0,onBlur:()=>{g.value[t.field]=!1}},null,8,["modelValue","onUpdate:modelValue","placeholder","clearable","onBlur"]),[[e.vShow,g.value[t.field]]])],8,z)):t.type==="select"?(e.openBlock(),e.createBlock(i,{key:2,modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,placeholder:t.placeholder||`请选择${t.label}`,clearable:t.clearable!==!1,multiple:t.multiple,filterable:t.filterable,remote:t.remote,"remote-method":t.remote?ae(t):void 0,loading:V.value[t.field]||!1,class:"form-item-select",teleported:!1,"reserve-keyword":""},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(D(t),s=>(e.openBlock(),e.createBlock(r,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","clearable","multiple","filterable","remote","remote-method","loading"])):t.type==="treeselect"?(e.openBlock(),e.createBlock(u,{key:3,modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,placeholder:t.placeholder||`请选择${t.label}`,clearable:t.clearable!==!1,multiple:t.multiple,data:le(t),"node-key":t.nodeKey||"value",props:t.props||{value:"value",label:"label",children:"children"},"show-checkbox":t.showCheckbox,filterable:t.filterable,teleported:!1,"popper-options":{placement:"bottom-start"},style:e.normalizeStyle({"--el-tree-select-dropdown-max-height":(t.maxDropdownHeight||300)+"px"}),"render-after-expand":!1,loading:V.value[t.field]||!1},null,8,["modelValue","onUpdate:modelValue","placeholder","clearable","multiple","data","node-key","props","show-checkbox","filterable","style","loading"])):t.type==="radio"?(e.openBlock(),e.createBlock(fe,{key:4,modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,class:"form-item-radio"},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.options,s=>(e.openBlock(),e.createBlock(S,{key:s.value,value:s.value,class:"form-item-radio-option"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(s.label),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.type==="checkbox"?(e.openBlock(),e.createBlock(pe,{key:5,modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,class:"form-item-checkbox"},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.options,s=>(e.openBlock(),e.createBlock(ue,{key:s.value,value:s.value,class:"form-item-checkbox-option"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(s.label),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.type==="date"?(e.openBlock(),e.createBlock(R,{key:6,modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,type:"date",placeholder:t.placeholder||`请选择${t.label}`,clearable:t.clearable!==!1,class:"form-item-date",teleported:!1},null,8,["modelValue","onUpdate:modelValue","placeholder","clearable"])):t.type==="daterange"?(e.openBlock(),e.createBlock(R,{key:7,modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,type:"daterange","start-placeholder":t.startPlaceholder||"开始日期","end-placeholder":t.endPlaceholder||"结束日期",clearable:t.clearable!==!1,class:"form-item-daterange",teleported:!1,"range-separator":"至"},null,8,["modelValue","onUpdate:modelValue","start-placeholder","end-placeholder","clearable"])):t.type==="number"?(e.openBlock(),e.createBlock(N,{key:8,modelValue:c.value[t.field],"onUpdate:modelValue":s=>c.value[t.field]=s,min:t.min,max:t.max,placeholder:t.placeholder||`请输入${t.label}`,"controls-position":t.controlsPosition||"right",class:"form-item-number"},null,8,["modelValue","onUpdate:modelValue","min","max","placeholder","controls-position"])):t.type==="numberrange"?(e.openBlock(),e.createElementBlock("div",H,[e.createVNode(N,{"model-value":T(t.field,0),min:t.min,max:t.max,placeholder:t.minPlaceholder||"最小值","controls-position":t.controlsPosition||"right",class:"form-item-number","onUpdate:modelValue":s=>I(t.field,0,s??null)},null,8,["model-value","min","max","placeholder","controls-position","onUpdate:modelValue"]),o[3]||(o[3]=e.createElementVNode("span",{class:"range-separator"},"-",-1)),e.createVNode(N,{"model-value":T(t.field,1),min:t.min,max:t.max,placeholder:t.maxPlaceholder||"最大值","controls-position":t.controlsPosition||"right",class:"form-item-number","onUpdate:modelValue":s=>I(t.field,1,s??null)},null,8,["model-value","min","max","placeholder","controls-position","onUpdate:modelValue"])])):t.type==="custom"?e.renderSlot(l.$slots,t.slotName||t.field,{key:10,model:c.value,field:t.field},void 0,!0):e.createCommentVNode("",!0)]),_:2},1032,["label","prop"])]),_:2},1032,["span"]))),128))]),_:3}),e.createVNode(j,{class:"advanced-form-actions","label-width":l.searchConfig.labelWidth||"100px",label:" "},{default:e.withCtx(()=>[e.createVNode(n,{type:"primary",icon:"Search",onClick:$},{default:e.withCtx(()=>o[4]||(o[4]=[e.createTextVNode(" 搜索 ",-1)])),_:1,__:[4]}),e.createVNode(n,{onClick:O,icon:"Refresh"},{default:e.withCtx(()=>o[5]||(o[5]=[e.createTextVNode(" 重置 ",-1)])),_:1,__:[5]})]),_:1},8,["label-width"])]),_:3},8,["model","label-width","inline"])])]),_:3},8,["visible","width"])):e.createCommentVNode("",!0)])]),y.value.length>0?(e.openBlock(),e.createElementBlock("div",Q,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(y.value,t=>(e.openBlock(),e.createBlock(be,{key:t.key,closable:"",onClose:s=>se(t.key),class:"search-tag"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(t.label)+": "+e.toDisplayString(ce(t)),1)]),_:2},1032,["onClose"]))),128)),e.createVNode(n,{type:"primary",link:"",onClick:de,class:"clear-all-tags"},{default:e.withCtx(()=>o[6]||(o[6]=[e.createTextVNode(" 清除所有 ",-1)])),_:1,__:[6]})])):e.createCommentVNode("",!0)])}}}),ge="",_e="",F=((x,A)=>{const h=x.__vccOpts||x;for(const[d,p]of A)h[d]=p;return h})(G,[["__scopeId","data-v-31329598"]]);m.ElementAdvancedSearch=F,m.default=F,Object.defineProperties(m,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
